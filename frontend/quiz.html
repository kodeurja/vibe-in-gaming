<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gauntlet Protocol | Gate of Intelligence</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
</head>

<body>
    <div class="app-container">
        <nav id="navbar" class="navbar">
            <div class="logo">GATE OF INTELLIGENCE</div>
            <ul class="nav-links">
                <li><a href="hub.html">Hub</a></li>
                <li><a href="roadmap.html">Road Map</a></li>
                <li><a href="game_dashboard.html">My Game</a></li>
                <li><a href="#" id="logout-btn" class="btn-logout">Logout</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="quiz-wrapper">
                <div class="cyber-terminal">
                    <div class="terminal-header">
                        <div class="terminal-title">>> GAUNTLET_PROTOCOL_V4.2 // GATE_ACCESS</div>
                        <div class="terminal-dots">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                    <div class="terminal-body">
                        <div class="hud-progress">
                            <span id="progress-text">UPLOADING CONSCIOUSNESS... 0%</span>
                            <span id="q-tracker">Q: 1/5</span>
                        </div>
                        <div id="quiz-ui">
                            <div class="question-card" id="question-text">Initializing Neural Link...</div>
                            <div class="options-grid" id="options-container"></div>
                        </div>
                        <div id="status-message" style="margin-top: 20px; color: var(--text-muted); min-height: 24px;">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Access Modal -->
    <div class="custom-modal-overlay" id="modal-overlay">
        <div class="custom-modal">
            <div class="modal-icon" id="modal-icon">ðŸ”’</div>
            <div class="modal-title" id="modal-title">ACCESS GRANTED</div>
            <div class="modal-message" id="modal-message">>> GATE UNLOCKED. PROCEED TO NODE.</div>
            <button class="modal-btn" id="modal-btn">ACKNOWLEDGE</button>
        </div>
    </div>

    <script type="module">
        import Auth from './static/js/auth.js';
        import CONFIG from './static/js/config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const quizId = urlParams.get('quiz_id');
        let quizData = [];
        let currentIdx = 0;
        let answers = [];

        function showCustomModal(title, message, isSuccess, callback) {
            const overlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal-icon').innerText = isSuccess ? 'ðŸ”“' : 'ðŸ”’';
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);
            document.getElementById('modal-btn').onclick = () => {
                overlay.classList.remove('active');
                setTimeout(() => { overlay.style.display = 'none'; if (callback) callback(); }, 300);
            };
        }

        async function init() {
            if (!quizId) { window.location.href = 'game_dashboard.html'; return; }
            const res = await fetch(`${CONFIG.API_BASE_URL}/api/quiz/${quizId}`, { credentials: 'include' });
            const data = await res.json();
            if (data.success) {
                quizData = data.questions;
                renderQuestion();
            } else {
                alert("Failed to load quiz.");
                window.location.href = 'game_dashboard.html';
            }
        }

        function renderQuestion() {
            if (currentIdx >= quizData.length) { submitQuiz(); return; }
            const q = quizData[currentIdx];
            document.getElementById('q-tracker').innerText = `Q: ${currentIdx + 1}/${quizData.length}`;
            document.getElementById('progress-text').innerText = `SYNC RATE: ${Math.round((currentIdx / quizData.length) * 100)}%`;
            const qText = document.getElementById('question-text');
            qText.style.opacity = 0;
            setTimeout(() => { qText.innerHTML = q.question; qText.style.opacity = 1; }, 200);
            const optsDiv = document.getElementById('options-container');
            optsDiv.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerText = `> ${opt}`;
                btn.onclick = () => selectOption(idx, btn);
                optsDiv.appendChild(btn);
            });
        }

        function selectOption(idx, btn) {
            document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'none');
            const q = quizData[currentIdx];
            const correctIdx = q.correct_index !== undefined ? q.correct_index : q.answer;
            const isCorrect = (idx === correctIdx);
            if (isCorrect) {
                btn.classList.add('correct');
                btn.innerHTML += ' [VERIFIED]';
                document.getElementById('status-message').innerText = ">> ANSWER CORRECT. UPLOADING...";
                document.getElementById('status-message').style.color = "var(--success)";
            } else {
                btn.classList.add('wrong');
                btn.innerHTML += ' [ERROR]';
                const allBtns = document.querySelectorAll('.option-btn');
                if (allBtns[correctIdx]) allBtns[correctIdx].classList.add('correct');
                document.getElementById('status-message').innerText = ">> CRITICAL FAILURE. SEQUENCE ABORTED.";
                document.getElementById('status-message').style.color = "var(--danger)";
            }
            answers.push(idx);
            setTimeout(() => { currentIdx++; renderQuestion(); }, 1500);
        }

        async function submitQuiz() {
            document.getElementById('question-text').innerText = ">> FINALIZING SEQUENCE...";
            document.getElementById('options-container').innerHTML = '<div class="pulsar-effect" style="color:var(--primary); text-align:center;">CALCULATING NEURAL CHECKSUM...</div>';
            const res = await fetch(`${CONFIG.API_BASE_URL}/api/submit_quiz`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quiz_id: quizId, answers: answers }),
                credentials: 'include'
            });
            const data = await res.json();
            if (data.success && data.passed) {
                document.getElementById('progress-text').innerText = "SYNC RATE: 100%";
                showCustomModal("ACCESS GRANTED", ">> GATE UNLOCKED. PROCEED TO NODE.", true, () => {
                    window.location.href = `puzzle.html?step=${data.redirect.split('/').pop()}`;
                });
            } else {
                showCustomModal("VERIFICATION FAILED", ">> CRITICAL ERROR: ACCESS DENIED. RETRYING SEQUENCE.", false, () => {
                    window.location.href = "quiz_setup.html";
                });
            }
        }
        init();
    </script>
</body>

</html>